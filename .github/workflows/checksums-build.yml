# ======================================================================
# APS Policy Registry — Checksums Builder
# File: .github/workflows/checksums-build.yml
# Purpose: Compute per-file sha256 + size and write the top-level
#          manifest_sha256 for checksums_manifest_v1.json on each push.
# Result:  If the manifest changes, this workflow commits the update.
# ======================================================================

name: Checksums Build

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]     # Run on pushes to main; adjust if needed
    paths:
      - "contract-analysis-policy-bundle/**"   # Only when policy/schemas change
      - ".github/workflows/checksums-build.yml"

jobs:
  build-checksums:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        # Pulls the repo so we can read/write files

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
        # jq is used to read/update JSON safely

      # Create/ensure checksums manifest exists (bootstrap if missing)
      - name: Define paths and bootstrap manifest file (idempotent)
        run: |
          set -euo pipefail

          MAN="contract-analysis-policy-bundle/policy/checksums_manifest_v1.json"
          MAN_DIR="$(dirname "$MAN")"

          mkdir -p "$MAN_DIR"

          if [ ! -f "$MAN" ]; then
            echo "Bootstrapping new checksums manifest at $MAN"
            cat >"$MAN" <<'JSON'
            {
              "manifest_version": "1.0",
              "generated_at": "1970-01-01T00:00:00Z",
              "manifest_sha256": "",
              "artifacts": []
            }
JSON
          else
            echo "Found existing manifest at $MAN"
          fi

          # Sanity check: valid JSON
          jq -e . "$MAN" >/dev/null
          echo "Manifest is parseable JSON"

      - name: Compute per-artifact sizes and sha256 digests
        run: |
          set -euo pipefail
          MAN="contract-analysis-policy-bundle/policy/checksums_manifest_v1.json"
          TMP="$(mktemp)"

          # Manifest must parse
          jq -e . "$MAN" >/dev/null

          # Overwrite size_bytes and sha256 for each artifact (handles "<pending>" too)
          jq -c '.artifacts[]' "$MAN" | while read -r ART; do
            P=$(jq -r '.path'  <<<"$ART")
            N=$(jq -r '.name'  <<<"$ART")

            if [ ! -f "$P" ]; then
              echo "❌ Missing artifact file: $P" >&2
              exit 1
            fi

            SIZE=$(stat -c%s "$P")
            SHA=$(sha256sum "$P" | cut -d' ' -f1)

            jq --arg p "$P" --arg sz "$SIZE" --arg sha "$SHA" '
              (.artifacts[] | select(.path == $p) | .size_bytes) = ($sz | tonumber)
              | (.artifacts[] | select(.path == $p) | .sha256)    = $sha
            ' "$MAN" > "$TMP" && mv "$TMP" "$MAN"

            echo "✅ $N updated size=$SIZE sha256=$SHA"
          done

      - name: Write top-level manifest_sha256 (canonical key sort)
        run: |
          set -euo pipefail
          MAN="contract-analysis-policy-bundle/policy/checksums_manifest_v1.json"
          TMP="$(mktemp)"

          # Canonicalize keys when hashing to avoid drift
          SHA=$(jq -S . "$MAN" | sha256sum | cut -d' ' -f1)

          jq --arg s "$SHA" '
            .manifest_sha256 = $s
            | .generated_at = (now | todateiso8601)
          ' "$MAN" > "$TMP" && mv "$TMP" "$MAN"

          echo "manifest_sha256=$SHA"

      - name: Verify no placeholders remain
        run: |
          set -euo pipefail
          MAN="contract-analysis-policy-bundle/policy/checksums_manifest_v1.json"
          BAD=$(jq -r '.artifacts[] | select((.sha256 == null) or (.sha256|tostring|test("^\\s*$")) or (.sha256 == "<pending>")) | .path' "$MAN" || true)
          if [ -n "$BAD" ]; then
            echo "❌ Artifacts still missing sha256:"
            echo "$BAD"
            exit 1
          fi
          echo "All artifact digests populated."

      - name: Show diff (for transparency)
        run: |
          set -euo pipefail
          echo "::group::Diff for checksums_manifest_v1.json"
          git diff -- contract-analysis-policy-bundle/policy/checksums_manifest_v1.json || true
          echo "::endgroup::"

      - name: Commit and push if changed
        run: |
          set -euo pipefail
          if ! git diff --quiet -- contract-analysis-policy-bundle/policy/checksums_manifest_v1.json; then
            echo "Changes detected — committing."
            git config user.name  "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add contract-analysis-policy-bundle/policy/checksums_manifest_v1.json
            git commit -m "ci: rebuild checksums manifest (auto)"
            git push
          else
            echo "No changes to commit."
          fi
