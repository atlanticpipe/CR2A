name: Checksums Build

on:
  workflow_dispatch: {}
  push:
    branches: [ main, branch ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write # required to push with GITHUB_TOKEN
  
jobs:
  build-checksums:
    runs-on: ubuntu-latest
    env:
      MAN: contract-analysis-policy-bundle/policy/checksums_manifest_v1.json
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}    # checks out the branch the workflow is running on

      - name: Install jq
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Debug current manifest (if present)
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "$MAN" ]; then
            echo "Found $MAN:"
            sed -n '1,120p' "$MAN"
            echo
            echo "jq parse check:"
            jq -e . "$MAN" || echo ">> jq failed parsing manifest"
          else
            echo "No manifest file found."
          fi

      - name: Update component sha256 (and optional size_bytes)
        run: |
          set -euo pipefail
          TMP="$(mktemp)"
          jq -e . "$MAN" >/dev/null

          # Iterate listed canonical and refresh their size/sha256
          jq -c '.canonical[]' "$MAN" | while read -r ART; do
            P="$(jq -r '.path'  <<<"$ART")"
            N="$(jq -r '.name'  <<<"$ART")"

            if [ ! -f "$P" ]; then
              echo "Missing canonical file: $P" >&2
              exit 1
            fi

            SIZE="$(stat -c%s "$P")"
            SHA="$(sha256sum "$P" | cut -d' ' -f1)"

            jq --arg p "$P" --arg sz "$SIZE" --arg sha "$SHA" '
              (.canonical[] | select(.path == $p) | .size_bytes) = ($sz | tonumber)
              | (.canonical[] | select(.path == $p) | .sha256)    = $sha
            ' "$MAN" > "$TMP" && mv "$TMP" "$MAN"

            echo "Updated $N size_bytes=$SIZE sha256=$SHA"
          done

      - name: Canonicalize manifest & stamp top-level hash
        shell: bash
        run: |
          set -euo pipefail
          
          # Ensure MAN is provided and file exists
          : "${MAN:?MAN env var is required}"
          test -f "$MAN" || { echo "::error::Manifest not found at $MAN"; exit 1; }
          
          TMP="$(mktemp)"

          # Canonicalize (keys sorted; canonical sorted by path; drop manifes_sha256)
          CANON="$(jq -S '
            .components |= (sort_by(.path)) |
            del(.manifest_sha256)
          ' "$MAN")" || { echo "::error::jq failed to process $MAN"; exit 1; }

          # Compute SHA-256 over canonical JSON (no trailing newline in input)
          CALC="$(printf '%s' "$CANON" | sha256sum | cut -d' ' -f1)"
          echo "canonical manifest_sha256 = $CALC"
          
          # Write hash + fresh timestamp back to the file (preserving everything else)
          printf '%s' "$CANON" \
          | jq --arg s "$CALC" '
            .manifest_sha256 = $s
            | .generated_at  = (now | todateiso8601)
          ' > "$TMP"

      - name: Assert manifest exists
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "$MAN" ]; then
            echo "Manifest present at $MAN"
          else
            echo "::error ::Manifest not found at $MAN"
            ls -la "$(dirname "$MAN")" || true
            exit 1
          fi
          
      - name: Show diff
        run: |
          set -euo pipefail
          git diff -- "$MAN" || true

      - name: Commit and push if changed
        shell: bash
        env:
          FILE: contract-analysis-policy-bundle/policy/checksums_manifest_v1.json
        run: |
          set -euo pipefail
          
          # Configure git (safe + identity)
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Is there anything to commit?
          if git diff --quiet -- "$FILE"; then
            echo "No changes to commit."
            # Keep the branch up to date anyway (non-fatal if nothing to pull)
            git fetch origin "${GITHUB_REF_NAME}" || true
            git pull --rebase origin "${GITHUB_REF_NAME}" || true
            exit 0
          fi

          # Stage, commit, and push the manifest update
          git add "$FILE"
          git commit -m "ci: refresh policy component checksums and manifest hash"
          git fetch origin "${GITHUB_REF_NAME}" || true
          git pull --rebase origin "${GITHUB_REF_NAME}" || true
          git push origin "HEAD:${GITHUB_REF_NAME}"
      
      - name: Update component sha256 (and optional size_bytes)
        shell: bash
        run: |
          set -euo pipefail
          MAN=contract-analysis-policy-bundle/policy/checksums_manifest_v1.json
          TMP="$(mktemp)"
          # fail clearly if JSON is invalid
          jq -e . "$MAN" >/dev/null || { echo "Manifest is not valid JSON: $MAN"; exit 1; }

          # Iterate over whichever array exists (.canonical or .artifacts). If both are null, use [] to avoid jq's "iterate over null".
          jq -c '(.canonical // .artifacts // [])[]' "$MAN" \   # ← pipe belongs OUTSIDE the quotes (no trailing | inside the jq filter)
            | while read -r ART; do                            # ← stream each artifact object as compact JSON into the loop
            p=$(jq -r '.path' <<<"$ART")                     # extract the artifact's file path
            [ -f "$p" ] || { echo "Missing canonical file: $p" >&2; exit 1; }  # hard fail if the file isn't on disk

          sz=$(stat -c%s "$p")             # recompute size
          sha=$(sha256sum "$p" | cut -d' ' -f1)  # recompute sha256

          # Write recomputed values back into BOTH arrays (if present) so everything stays in sync
          jq --arg p "$p" --argjson sz "$sz" --arg sha "$sha" '
            ( .canonical |= (map( if .path==$p then (.size_bytes=$sz|.sha256=$sha) else . end )) ) |
            ( .artifacts |= (map( if .path==$p then (.size_bytes=$sz|.sha256=$sha) else . end )) )
          ' "$MAN" > "$TMP" && mv "$TMP" "$MAN"

          echo "Updated $p size_bytes=$sz sha256=$sha"
          done
