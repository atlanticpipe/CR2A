name: Checksums Build

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]
    paths:
      - "contract-analysis-policy-bundle/**"
      - ".github/workflows/checksums-build.yml"

jobs:
  build-checksums:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Bootstrap manifest if missing
        run: |
          set -euo pipefail
          MAN="contract-analysis-policy-bundle/policy/checksums_manifest_v1.json"
          MAN_DIR="$(dirname "$MAN")"
          mkdir -p "$MAN_DIR"
          if [ ! -f "$MAN" ]; then
            # Use printf instead of heredoc to avoid YAML/heredoc edge cases
            printf '%s\n' \
              '{' \
              '  "manifest_version": "1.0",' \
              '  "generated_at": "1970-01-01T00:00:00Z",' \
              '  "manifest_sha256": "",' \
              '  "artifacts": []' \
              '}' >"$MAN"
          fi
          jq -e . "$MAN" >/dev/null

      - name: Update artifact size_bytes and sha256
        run: |
          set -euo pipefail
          MAN="contract-analysis-policy-bundle/policy/checksums_manifest_v1.json"
          TMP="$(mktemp)"
          jq -e . "$MAN" >/dev/null

          # Iterate listed artifacts and refresh their size/sha256
          jq -c '.artifacts[]' "$MAN" | while read -r ART; do
            P="$(jq -r '.path'  <<<"$ART")"
            N="$(jq -r '.name'  <<<"$ART")"
            if [ ! -f "$P" ]; then
              echo "Missing artifact file: $P" >&2
              exit 1
            fi
            SIZE="$(stat -c%s "$P")"
            SHA="$(sha256sum "$P" | cut -d' ' -f1)"

            jq --arg p "$P" --arg sz "$SIZE" --arg sha "$SHA" '
              (.artifacts[] | select(.path == $p) | .size_bytes) = ($sz | tonumber)
              | (.artifacts[] | select(.path == $p) | .sha256)    = $sha
            ' "$MAN" > "$TMP" && mv "$TMP" "$MAN"

            echo "Updated $N size_bytes=$SIZE sha256=$SHA"
          done
      - name: Write top-level manifest_sha256 (canonical key sort; field removed)
        run: |
          set -euo pipefail
          MAN="contract-analysis-policy-bundle/policy/checksums_manifest_v1.json"
          TMP="$(mktemp)"

    # Canonicalize JSON: sort keys recursively, sort artifacts array by path
    CANON=$(jq -S '
      .artifacts |= (sort_by(.path)) 
      | del(.manifest_sha256)
    ' "$MAN")

    CALC=$(echo "$CANON" | sha256sum | cut -d' ' -f1)
    echo "canonical manifest_sha256 = $CALC"

    # Write back manifest with updated hash + generated_at
    echo "$CANON" | jq --arg s "$CALC" '
      .manifest_sha256 = $s
      | .generated_at = (now | todateiso8601)
    ' > "$TMP"

    mv "$TMP" "$MAN"
    echo "manifest_sha256=$CALC"

          # Stamp the manifest with the computed hash and fresh generated_at
          jq --arg s "$CALC" '
            .manifest_sha256 = $s
            | .generated_at = (now | todateiso8601)
          ' "$MAN" > "$TMP" && mv "$TMP" "$MAN"

      - name: Show diff
        run: |
          set -euo pipefail
          git diff -- contract-analysis-policy-bundle/policy/checksums_manifest_v1.json || true

      - name: Commit and push if changed
        run: |
          set -euo pipefail
          FILE="contract-analysis-policy-bundle/policy/checksums_manifest_v1.json"
          if ! git diff --quiet -- "$FILE"; then
            git config user.name  "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add "$FILE"
            git commit -m "ci: rebuild checksums manifest (auto)"
            git push
          else
            echo "No changes to commit."
          fi
