# ======================================================================
# Policy Validate (strict)
# ======================================================================

name: Policy Validate

on:
  workflow_dispatch: {}
  push:
    branches: [ main, Working ]
  workflow_run:
    workflows: ["Checksums Build"]
    types: [completed]

permissions:
  contents: read

env:
  MANIFEST_PATH: contract-analysis-policy-bundle/policy/checksums_manifest_v1.json
  LOCK_PATH:     contract-analysis-policy-bundle/policy/version_lock.schemas_v1.json

jobs:
  validate:
    # Only run after Checksums Build if it SUCCEEDED; always run for push/dispatch
    if: >
      github.event_name != 'workflow_run' ||
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo (correct SHA)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}

      - name: Install jq
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Check manifest presence & parseable
        run: |
          set -euo pipefail
          test -f "$MANIFEST_PATH"
          jq -e . "$MANIFEST_PATH" >/dev/null
          echo "âœ… Manifest is present and valid JSON"

      - name: Enforce top-level manifest_sha256 (canonical)
        run: |
          set -euo pipefail
          # Canonicalize EXACTLY like the build job (no -c; sort keys; sort artifacts; drop field)
          CANON=$(jq -S '
            .artifacts |= (sort_by(.path))
            | del(.manifest_sha256)
          ' "$MANIFEST_PATH")

          # Compute hash with no extra newline
          CALC=$(printf '%s' "$CANON" | sha256sum | cut -d' ' -f1)
          STORED=$(jq -r '.manifest_sha256' "$MANIFEST_PATH")

          echo "Stored: $STORED"
          echo "Calc  : $CALC"

          if [ -z "$STORED" ] || [ "$STORED" = "null" ]; then
