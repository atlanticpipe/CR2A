name: Publish Lambda Layers

on:
  push:
    branches: ["main"]
    paths:
      - 'src/**'
      - 'schemas/**'
      - 'templates/**'
      - 'requirements-core.txt'
      - 'requirements-optional.txt'
      - '.github/workflows/publish-layers.yml'
      - '.github/actions/build-layer/**'
  workflow_dispatch:
    inputs:
      force_rebuild_all:
        description: 'Force rebuild all layers'
        required: false
        default: false
        type: boolean
      rebuild_shared_code:
        description: 'Force rebuild shared code layer only'
        required: false
        default: false
        type: boolean
      rebuild_dependencies:
        description: 'Force rebuild dependency layers only'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: us-east-1
  PYTHON_VERSION: '3.11'
  SHARED_CODE_LAYER_NAME: cr2a-shared-code
  DEPENDENCY_LAYER_NAME: cr2a-shared-deps
  WORKER_LAYER_NAME: cr2a-shared-deps

jobs:
  # Detect what changed to determine which layers to rebuild
  detect_changes:
    runs-on: ubuntu-latest
    outputs:
      shared_code_changed: ${{ steps.changes.outputs.shared_code_changed }}
      dependencies_changed: ${{ steps.changes.outputs.dependencies_changed }}
      force_rebuild_all: ${{ steps.changes.outputs.force_rebuild_all }}
      rebuild_shared_code: ${{ steps.changes.outputs.rebuild_shared_code }}
      rebuild_dependencies: ${{ steps.changes.outputs.rebuild_dependencies }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changes
        id: changes
        run: |
          # Check for manual workflow dispatch inputs
          FORCE_REBUILD_ALL="${{ github.event.inputs.force_rebuild_all }}"
          REBUILD_SHARED_CODE="${{ github.event.inputs.rebuild_shared_code }}"
          REBUILD_DEPENDENCIES="${{ github.event.inputs.rebuild_dependencies }}"
          
          if [ "$FORCE_REBUILD_ALL" = "true" ]; then
            echo "force_rebuild_all=true" >> "$GITHUB_OUTPUT"
            echo "shared_code_changed=true" >> "$GITHUB_OUTPUT"
            echo "dependencies_changed=true" >> "$GITHUB_OUTPUT"
            echo "rebuild_shared_code=false" >> "$GITHUB_OUTPUT"
            echo "rebuild_dependencies=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          if [ "$REBUILD_SHARED_CODE" = "true" ]; then
            echo "rebuild_shared_code=true" >> "$GITHUB_OUTPUT"
            echo "shared_code_changed=true" >> "$GITHUB_OUTPUT"
            echo "dependencies_changed=false" >> "$GITHUB_OUTPUT"
            echo "force_rebuild_all=false" >> "$GITHUB_OUTPUT"
            echo "rebuild_dependencies=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          if [ "$REBUILD_DEPENDENCIES" = "true" ]; then
            echo "rebuild_dependencies=true" >> "$GITHUB_OUTPUT"
            echo "shared_code_changed=false" >> "$GITHUB_OUTPUT"
            echo "dependencies_changed=true" >> "$GITHUB_OUTPUT"
            echo "force_rebuild_all=false" >> "$GITHUB_OUTPUT"
            echo "rebuild_shared_code=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          # For push events, detect what files changed
          if [ "${{ github.event_name }}" = "push" ]; then
            # Check if shared code changed (src/, schemas/, templates/)
            if git diff --name-only HEAD~1 HEAD | grep -E "(src/|schemas/|templates/)"; then
              echo "shared_code_changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "shared_code_changed=false" >> "$GITHUB_OUTPUT"
            fi
            
            # Check if dependencies changed
            if git diff --name-only HEAD~1 HEAD | grep -E "(requirements.*\.txt|\.github/workflows/publish-layers\.yml|\.github/actions/build-layer/)"; then
              echo "dependencies_changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "dependencies_changed=false" >> "$GITHUB_OUTPUT"
            fi
          else
            # Default for other triggers
            echo "shared_code_changed=true" >> "$GITHUB_OUTPUT"
            echo "dependencies_changed=true" >> "$GITHUB_OUTPUT"
          fi
          
          echo "force_rebuild_all=false" >> "$GITHUB_OUTPUT"
          echo "rebuild_shared_code=false" >> "$GITHUB_OUTPUT"
          echo "rebuild_dependencies=false" >> "$GITHUB_OUTPUT"

  # Build and publish shared code layer
  publish_shared_code_layer:
    runs-on: ubuntu-latest
    needs: detect_changes
    if: needs.detect_changes.outputs.shared_code_changed == 'true'
    permissions:
      id-token: write
      contents: read
    outputs:
      layer_arn: ${{ steps.build_layer.outputs.layer-arn }}
      layer_version: ${{ steps.build_layer.outputs.layer-version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_LAMBDA_DEPLOY_ROLE_ARN }}

      - name: Build and publish shared code layer
        id: build_layer
        uses: ./.github/actions/build-layer
        with:
          layer-name: ${{ env.SHARED_CODE_LAYER_NAME }}
          layer-type: 'shared-code'
          source-paths: 'src,schemas,templates'
          aws-region: ${{ env.AWS_REGION }}

  # Build and publish API dependency layer (core + optional)
  publish_api_dependency_layer:
    runs-on: ubuntu-latest
    needs: detect_changes
    if: needs.detect_changes.outputs.dependencies_changed == 'true'
    permissions:
      id-token: write
      contents: read
    outputs:
      layer_arn: ${{ steps.build_layer.outputs.layer-arn }}
      layer_version: ${{ steps.build_layer.outputs.layer-version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_LAMBDA_DEPLOY_ROLE_ARN }}

      - name: Build and publish API dependency layer
        id: build_layer
        uses: ./.github/actions/build-layer
        with:
          layer-name: ${{ env.DEPENDENCY_LAYER_NAME }}
          layer-type: 'dependencies'
          requirements-files: 'requirements-core.txt,requirements-optional.txt'
          python-version: ${{ env.PYTHON_VERSION }}
          aws-region: ${{ env.AWS_REGION }}

  # Build and publish worker dependency layer (core only)
  publish_worker_dependency_layer:
    runs-on: ubuntu-latest
    needs: detect_changes
    if: needs.detect_changes.outputs.dependencies_changed == 'true'
    permissions:
      id-token: write
      contents: read
    outputs:
      layer_arn: ${{ steps.build_layer.outputs.layer-arn }}
      layer_version: ${{ steps.build_layer.outputs.layer-version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_LAMBDA_DEPLOY_ROLE_ARN }}

      - name: Build and publish worker dependency layer
        id: build_layer
        uses: ./.github/actions/build-layer
        with:
          layer-name: ${{ env.WORKER_LAYER_NAME }}
          layer-type: 'dependencies'
          requirements-files: 'requirements-core.txt'
          python-version: ${{ env.PYTHON_VERSION }}
          aws-region: ${{ env.AWS_REGION }}

  # Verify all published layers
  verify_layers:
    runs-on: ubuntu-latest
    needs: [detect_changes, publish_shared_code_layer, publish_api_dependency_layer, publish_worker_dependency_layer]
    if: |
      always() && 
      (needs.publish_shared_code_layer.result == 'success' || 
       needs.publish_api_dependency_layer.result == 'success' || 
       needs.publish_worker_dependency_layer.result == 'success')
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_LAMBDA_DEPLOY_ROLE_ARN }}

      - name: Verify published layers
        run: |
          echo "=== Layer Publication Summary ==="
          echo "Shared code layer rebuilt: ${{ needs.detect_changes.outputs.shared_code_changed }}"
          echo "Dependency layers rebuilt: ${{ needs.detect_changes.outputs.dependencies_changed }}"
          echo ""
          
          # Verify shared code layer if rebuilt
          if [ "${{ needs.publish_shared_code_layer.result }}" = "success" ]; then
            echo "=== Shared Code Layer ==="
            aws lambda get-layer-version-by-arn \
              --arn "${{ needs.publish_shared_code_layer.outputs.layer_arn }}" \
              --query '[Arn,Version,CreatedDate,Description]' \
              --output table
            echo ""
          fi
          
          # Verify API dependency layer if rebuilt
          if [ "${{ needs.publish_api_dependency_layer.result }}" = "success" ]; then
            echo "=== API Dependency Layer ==="
            aws lambda get-layer-version-by-arn \
              --arn "${{ needs.publish_api_dependency_layer.outputs.layer_arn }}" \
              --query '[Arn,Version,CreatedDate,Description]' \
              --output table
            echo ""
          fi
          
          # Verify worker dependency layer if rebuilt
          if [ "${{ needs.publish_worker_dependency_layer.result }}" = "success" ]; then
            echo "=== Worker Dependency Layer ==="
            aws lambda get-layer-version-by-arn \
              --arn "${{ needs.publish_worker_dependency_layer.outputs.layer_arn }}" \
              --query '[Arn,Version,CreatedDate,Description]' \
              --output table
            echo ""
          fi
          
          echo "âœ… All layers verified successfully!"

  # Store layer metadata for other workflows
  store_layer_metadata:
    runs-on: ubuntu-latest
    needs: [detect_changes, publish_shared_code_layer, publish_api_dependency_layer, publish_worker_dependency_layer, verify_layers]
    if: needs.verify_layers.result == 'success'
    steps:
      - name: Store layer ARNs as artifacts
        run: |
          mkdir -p layer-metadata
          
          # Store shared code layer ARN if rebuilt
          if [ "${{ needs.publish_shared_code_layer.result }}" = "success" ]; then
            echo "${{ needs.publish_shared_code_layer.outputs.layer_arn }}" > layer-metadata/shared-code-layer-arn.txt
            echo "${{ needs.publish_shared_code_layer.outputs.layer_version }}" > layer-metadata/shared-code-layer-version.txt
          fi
          
          # Store API dependency layer ARN if rebuilt
          if [ "${{ needs.publish_api_dependency_layer.result }}" = "success" ]; then
            echo "${{ needs.publish_api_dependency_layer.outputs.layer_arn }}" > layer-metadata/api-dependency-layer-arn.txt
            echo "${{ needs.publish_api_dependency_layer.outputs.layer_version }}" > layer-metadata/api-dependency-layer-version.txt
          fi
          
          # Store worker dependency layer ARN if rebuilt
          if [ "${{ needs.publish_worker_dependency_layer.result }}" = "success" ]; then
            echo "${{ needs.publish_worker_dependency_layer.outputs.layer_arn }}" > layer-metadata/worker-dependency-layer-arn.txt
            echo "${{ needs.publish_worker_dependency_layer.outputs.layer_version }}" > layer-metadata/worker-dependency-layer-version.txt
          fi
          
          echo "Layer metadata stored for downstream workflows"

      - name: Upload layer metadata
        uses: actions/upload-artifact@v4
        with:
          name: layer-metadata
          path: layer-metadata/
          retention-days: 7

  # Cleanup old layer versions
  cleanup_old_layers:
    runs-on: ubuntu-latest
    needs: [verify_layers, publish_shared_code_layer, publish_api_dependency_layer, publish_worker_dependency_layer]
    if: needs.verify_layers.result == 'success'
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_LAMBDA_DEPLOY_ROLE_ARN }}

      - name: Cleanup old layer versions
        run: |
          echo "Cleaning up old layer versions (keeping latest 5)..."
          
          # Function to cleanup layer versions
          cleanup_layer() {
            local layer_name=$1
            echo "Cleaning up $layer_name..."
            
            VERSIONS=$(aws lambda list-layer-versions \
              --layer-name "$layer_name" \
              --query 'LayerVersions[].Version' \
              --output text | tr '\t' '\n' | sort -nr)
            
            # Skip first 5 versions (keep them), delete the rest
            echo "$VERSIONS" | tail -n +6 | while read version; do
              if [ -n "$version" ]; then
                echo "Deleting $layer_name version $version..."
                aws lambda delete-layer-version \
                  --layer-name "$layer_name" \
                  --version-number "$version" || true
              fi
            done
          }
          
          # Cleanup layers that were rebuilt
          if [ "${{ needs.publish_shared_code_layer.result }}" = "success" ]; then
            cleanup_layer "${{ env.SHARED_CODE_LAYER_NAME }}"
          fi
          
          if [ "${{ needs.publish_api_dependency_layer.result }}" = "success" ]; then
            cleanup_layer "${{ env.DEPENDENCY_LAYER_NAME }}"
          fi
          
          if [ "${{ needs.publish_worker_dependency_layer.result }}" = "success" ]; then
            cleanup_layer "${{ env.WORKER_LAYER_NAME }}"
          fi
          
          echo "Layer cleanup completed."