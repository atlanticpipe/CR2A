#!/bin/bash
# CR2A Testing Framework CLI Wrapper Script
# Provides convenient shortcuts for common testing operations

set -e

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
CLI_SCRIPT="$SCRIPT_DIR/cr2a_test_cli.py"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${NC}"
}

# Function to check if Python script exists
check_cli_script() {
    if [[ ! -f "$CLI_SCRIPT" ]]; then
        print_status $RED "Error: CLI script not found at $CLI_SCRIPT"
        exit 1
    fi
}

# Function to check Python environment
check_python_env() {
    if ! command -v python3 &> /dev/null; then
        print_status $RED "Error: python3 not found. Please install Python 3.8 or later."
        exit 1
    fi
    
    # Check if we're in a virtual environment or have required packages
    if ! python3 -c "import boto3" &> /dev/null; then
        print_status $YELLOW "Warning: boto3 not found. You may need to activate a virtual environment or install dependencies."
        print_status $YELLOW "Run: pip install -r requirements.txt"
    fi
}

# Function to show usage
show_usage() {
    cat << EOF
CR2A Testing Framework CLI

Usage: $0 <command> [options]

Commands:
  test <phase>              Run tests (component|integration|all)
  deploy <resource>         Deploy resources (lambda|layers)
  setup <target>            Set up AWS resources (aws)
  validate [component]      Validate setup (iam|logs|lambda|stepfunctions|apigateway|all)
  report                    Generate test report
  layers <action>           Manage Lambda layers (create|list|cleanup)
  config <action>           Manage configuration (create|show|validate)
  
Quick Commands:
  quick-test               Run all tests with verbose output
  quick-setup              Set up all AWS resources and deploy Lambda functions
  quick-validate           Validate entire setup
  status                   Show current system status
  
Options:
  --region <region>        AWS region (default: us-east-1)
  --config <file>          Configuration file path
  --verbose                Verbose output
  --help                   Show detailed help

Examples:
  $0 quick-test                    # Run all tests
  $0 test component --verbose      # Run component tests with verbose output
  $0 deploy lambda                 # Deploy Lambda test functions
  $0 setup aws --resource all     # Set up all AWS resources
  $0 validate --verbose           # Validate setup with detailed output
  $0 config create                 # Create sample configuration file

For detailed help on any command:
  $0 <command> --help

EOF
}

# Function to run quick test
quick_test() {
    print_status $BLUE "üöÄ Running CR2A Quick Test..."
    python3 "$CLI_SCRIPT" test all --verbose --generate-report "$@"
}

# Function to run quick setup
quick_setup() {
    print_status $BLUE "üîß Running CR2A Quick Setup..."
    
    print_status $YELLOW "Step 1: Setting up AWS resources..."
    python3 "$CLI_SCRIPT" setup aws --resource all "$@"
    
    print_status $YELLOW "Step 2: Deploying Lambda functions..."
    python3 "$CLI_SCRIPT" deploy lambda "$@"
    
    print_status $YELLOW "Step 3: Validating setup..."
    python3 "$CLI_SCRIPT" validate --component all "$@"
    
    print_status $GREEN "‚úÖ Quick setup completed!"
}

# Function to run quick validation
quick_validate() {
    print_status $BLUE "üîç Running CR2A Quick Validation..."
    python3 "$CLI_SCRIPT" validate --component all --verbose "$@"
}

# Function to show system status
show_status() {
    print_status $BLUE "üìä CR2A System Status"
    echo
    
    print_status $YELLOW "Validating AWS Setup..."
    python3 "$CLI_SCRIPT" validate --component all "$@"
    
    echo
    print_status $YELLOW "Configuration:"
    python3 "$SCRIPT_DIR/config_manager.py" show "$@"
}

# Main script logic
main() {
    # Check prerequisites
    check_cli_script
    check_python_env
    
    # Change to project root directory
    cd "$PROJECT_ROOT"
    
    # Handle commands
    case "${1:-}" in
        "test")
            shift
            python3 "$CLI_SCRIPT" test "$@"
            ;;
        "deploy")
            shift
            python3 "$CLI_SCRIPT" deploy "$@"
            ;;
        "setup")
            shift
            python3 "$CLI_SCRIPT" setup "$@"
            ;;
        "validate")
            shift
            python3 "$CLI_SCRIPT" validate "$@"
            ;;
        "report")
            shift
            python3 "$CLI_SCRIPT" report "$@"
            ;;
        "layers")
            shift
            python3 "$CLI_SCRIPT" layers "$@"
            ;;
        "config")
            shift
            python3 "$SCRIPT_DIR/config_manager.py" "$@"
            ;;
        "quick-test")
            shift
            quick_test "$@"
            ;;
        "quick-setup")
            shift
            quick_setup "$@"
            ;;
        "quick-validate")
            shift
            quick_validate "$@"
            ;;
        "status")
            shift
            show_status "$@"
            ;;
        "--help"|"-h"|"help")
            show_usage
            ;;
        "")
            print_status $RED "Error: No command specified"
            echo
            show_usage
            exit 1
            ;;
        *)
            print_status $RED "Error: Unknown command '$1'"
            echo
            show_usage
            exit 1
            ;;
    esac
}

# Run main function with all arguments
main "$@"