{
  // =====================================================================
  // APS Contract Analysis — Run Manifest Schema v1
  // File: contract-analysis-policy-bundle/schemas/run_manifest_schema_v1.json
  // Purpose: Validates the per-run manifest the orchestrator emits.
  // Notes: Keep this stable; downstream systems depend on these keys.
  // =====================================================================

  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "APS Run Manifest",
  "version": "1.0",

  "type": "object",
  "required": [
    "run_id",
    "contract_id",
    "timestamps",
    "fdot",
    "versions",
    "artifacts",
    "retrieval_flags",
    "metrics",
    "audit"
  ],
  "additionalProperties": false,

  "properties": {
    "run_id": { "type": "string" },         // Unique run identifier (e.g., run_123...)
    "contract_id": { "type": "string" },    // Your internal contract identifier

    "timestamps": {
      // UTC ISO 8601 stamps for lifecycle traceability
      "type": "object",
      "required": ["submitted_at", "started_at", "completed_at"],
      "additionalProperties": false,
      "properties": {
        "submitted_at": { "type": "string" }, // e.g., 2025-09-30T14:22:11Z
        "started_at": { "type": "string" },
        "completed_at": { "type": "string" }
      }
    },

    "fdot": {
      // FDOT gating + inference info captured up front
      "type": "object",
      "required": ["fdot_contract", "fdot_year", "confidence", "rationale", "evidence"],
      "additionalProperties": false,
      "properties": {
        "fdot_contract": { "type": "boolean" },   // true if detected as FDOT-governed
        "fdot_year": {                             // string or null (null until locked)
          "type": ["string", "null"]
        },
        "confidence": { "type": "number" },       // detector confidence (0..1)
        "rationale": { "type": "string" },        // brief why/how year was determined
        "evidence": {                              // list of human-auditable refs
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },

    "versions": {
      // Version pinning for reproducibility and diffability
      "type": "object",
      "required": ["rulebook_version", "schema_version"],
      "additionalProperties": false,
      "properties": {
        "rulebook_version": { "type": "string" }, // e.g., "1.0"
        "schema_version": { "type": "string" }    // e.g., "1.0"
      }
    },

    "artifacts": {
      // Where the outputs live and their integrity digests
      "type": "object",
      "required": ["json_uri", "pdf_uri", "checksums"],
      "additionalProperties": false,
      "properties": {
        "json_uri": { "type": "string" },  // URI to the JSON output (s3, https, etc.)
        "pdf_uri": { "type": "string" },   // URI to the rendered PDF
        "checksums": {
          "type": "object",
          "required": ["json_sha256", "pdf_sha256"],
          "additionalProperties": false,
          "properties": {
            "json_sha256": { "type": "string" },  // hex-encoded SHA-256
            "pdf_sha256": { "type": "string" }
          }
        }
      }
    },

    "retrieval_flags": {
      // Retrieval/runtime knobs captured for audit + reproducibility
      "type": "object",
      "required": ["fdot_year_filter_locked", "embedding_model", "stores"],
      "additionalProperties": false,
      "properties": {
        "fdot_year_filter_locked": { "type": "boolean" }, // true if year pinned pre-analysis
        "embedding_model": { "type": "string" },          // e.g., "text-embedding-3-large"
        "stores": {
          // Logical names → vector store identifiers/aliases resolved at runtime
          "type": "object",
          "additionalProperties": { "type": "string" }
        }
      }
    },

    "metrics": {
      // Cost/latency/token telemetry for ops & forecasting
      "type": "object",
      "required": ["tokens", "latency_ms", "cost_usd"],
      "additionalProperties": false,
      "properties": {
        "tokens": {
          "type": "object",
          "required": ["prompt", "completion", "total"],
          "additionalProperties": false,
          "properties": {
            "prompt": { "type": "integer" },     // input tokens
            "completion": { "type": "integer" }, // output tokens
            "total": { "type": "integer" }       // sum(prompt, completion)
          }
        },
        "latency_ms": { "type": "integer" },     // end-to-end duration in ms
        "cost_usd": { "type": "number" }         // monetized cost for the run
      }
    },

    "audit": {
      // Additional context used to validate/trace a run
      "type": "object",
      "required": ["source_checksums", "notes"],
      "additionalProperties": false,
      "properties": {
        "source_checksums": {
          "type": "array",
          "items": { "type": "string" }  // hashes of inputs (contracts/specs) if available
        },
        "notes": { "type": "string" }    // free-form operator/system notes
      }
    }
  }
}
