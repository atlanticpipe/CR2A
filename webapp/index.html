<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CR2A | Clause Risk & Compliance Analyzer</title>
  <meta name="description" content="Automated contract risk analysis powered by OpenAI">
  <link rel="icon" href="about:blank" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <!-- ===== HEADER ===== -->
  <header class="app-header">
    <div class="header-container">
      <div class="header-brand">
        <div class="company-logo">APS</div>
        <div class="company-info">
          <p class="company-name">Atlantic Pipe Services</p>
          <p class="app-name">CR2A</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn ghost small" id="settings-btn" title="Settings">‚öôÔ∏è Settings</button>
        <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">üåô Dark</button>
      </div>
    </div>
  </header>

  <!-- ===== BREADCRUMB ===== -->
  <div class="breadcrumb-container">
    <div class="breadcrumb">
      <span class="breadcrumb-item">Analyzer</span>
      <span class="breadcrumb-separator">‚Ä∫</span>
      <span class="breadcrumb-item active">GitHub Pages Edition v2.0</span>
    </div>
  </div>

  <!-- ===== MAIN CONTENT ===== -->
  <div class="page">
    <!-- ===== HERO SECTION ===== -->
    <section class="hero">
      <div class="brand">
        <div>
          <p class="eyebrow">Contract Risk Analysis</p>
          <h1>Clause Risk & Compliance Analyzer</h1>
          <p class="lede">
            Upload a contract and analyze potential risks and compliance issues. Powered by OpenAI for intelligent analysis with executive-ready outputs.
          </p>
          <p class="helper">
            <strong>New:</strong> Client-side processing for enhanced privacy. Files never leave your browser.
          </p>
        </div>
      </div>

      <!-- ===== SUBMISSION CARD ===== -->
      <div class="hero-card">
        <div class="hero-title">
          <div>
            <p class="eyebrow">Start Analysis</p>
            <h3>Submit Contract</h3>
          </div>
          <span class="pill" id="ready-status">Ready to begin</span>
        </div>
        <form id="submission-form" novalidate>
          <!-- Contract ID Field -->
          <div class="field">
            <label for="contract-id">
              Contract ID
              <span class="required" aria-label="required">*</span>
            </label>
            <input 
              type="text" 
              id="contract-id"
              name="contract_id" 
              placeholder="e.g., FDOT-Bridge-2024-18" 
              required
              aria-describedby="contract-id-help"
            />
            <p class="field-help" id="contract-id-help">A unique identifier for tracking</p>
            <p class="field-error">Please enter a valid contract ID</p>
          </div>

          <!-- Additional Metadata Fields -->
          <div class="row">
            <div class="field">
              <label for="project-title">Project Title</label>
              <input 
                type="text" 
                id="project-title"
                name="project_title" 
                placeholder="e.g., Bridge Rehabilitation Project"
              />
            </div>
            <div class="field">
              <label for="owner">Contract Owner</label>
              <input 
                type="text" 
                id="owner"
                name="owner" 
                placeholder="e.g., FDOT District 5"
              />
            </div>
          </div>

          <!-- Contract File Field -->
          <div class="field">
            <label for="file-input">
              Contract File
              <span class="required" aria-label="required">*</span>
            </label>
            <label class="dropzone" id="dropzone" aria-describedby="file-help">
              <input type="file" id="file-input" name="contract_file" accept=".pdf,.doc,.docx,.txt" required />
              <div>
                <p class="drop-title">üìÑ Drop contract or click to browse</p>
                <p class="drop-sub">PDF, DOCX, or TXT files up to 500 MB</p>
                <div id="file-name" class="file-name">No file selected</div>
              </div>
            </label>
            <p class="field-help" id="file-help">
              Supported formats: PDF, DOCX, TXT. File is processed entirely in your browser.
            </p>
            <p class="field-error">Please select a valid contract file</p>
          </div>

          <!-- LLM Toggle -->
          <div class="field">
            <label style="display: flex; align-items: center; gap: 12px;">
              <span>Enable AI Analysis</span>
              <div class="switch">
                <input type="checkbox" id="llm_toggle" checked />
                <label for="llm_toggle"></label>
              </div>
            </label>
            <p class="field-help">Uses OpenAI GPT-4 for comprehensive contract analysis</p>
          </div>

          <!-- Upload Progress -->
          <div class="upload-status">
            <div class="progress" id="upload-progress" hidden>
              <div class="progress-bar" id="upload-progress-bar"></div>
              <span id="upload-progress-text">0%</span>
            </div>
            <p id="upload-message" class="meta"></p>
          </div>

          <!-- Submit Buttons -->
          <div class="cta-group">
            <button type="submit" class="btn primary" id="submit-btn">
              <span>Analyze Contract</span>
            </button>
            <button type="button" class="btn ghost" id="run-demo">
              Run Demo
            </button>
          </div>
        </form>
      </div>
    </section>

    <!-- ===== MAIN CONTENT ===== -->
    <main class="content">
      <!-- ===== TIMELINE SECTION ===== -->
      <section class="panel">
        <div class="panel-header">
          <div>
            <p class="eyebrow">Processing</p>
            <h3>Analysis Timeline</h3>
          </div>
          <span class="pill soft">Live Updates</span>
        </div>
        <div class="timeline" id="timeline">
          <div class="timeline-row">
            <div class="dot active"></div>
            <div>
              <p class="title">Ready for submission</p>
              <p class="meta">Upload a contract and configure settings to begin analysis</p>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== RESULTS SECTION ===== -->
      <section class="panel grid">
        <div>
          <div class="panel-header">
            <div>
              <p class="eyebrow">Results</p>
              <h3>Analysis Output</h3>
            </div>
            <span class="pill soft">Pending</span>
          </div>
          <div class="output">
            <div class="output-row">
              <span class="output-label">Analysis Status</span>
              <span class="output-value" id="validation-status">
                <span>Pending</span>
              </span>
            </div>
            <div class="output-row">
              <span class="output-label">Risk Level</span>
              <span class="output-value" id="risk-level">‚Äî</span>
            </div>
            <div class="output-row">
              <span class="output-label">Findings Found</span>
              <span class="output-value" id="findings-count">0</span>
            </div>
            <div class="output-row">
              <span class="output-label">Report Status</span>
              <span class="output-value" id="export-status">Pending</span>
            </div>
            <div class="output-row output-action">
              <span class="output-label">Download Report</span>
              <a id="download-report" class="btn small" href="#" aria-disabled="true">Get Report</a>
            </div>
          </div>
        </div>

        <!-- ===== INSIGHTS SIDEBAR ===== -->
        <aside class="insights-sidebar">
          <div class="insight">
            <h4>About CR2A v2.0</h4>
            <ul>
              <li>OpenAI-powered analysis</li>
              <li>Client-side processing</li>
              <li>Risk identification & scoring</li>
              <li>Compliance validation</li>
              <li>Executive summaries</li>
              <li>Secure PDF export</li>
            </ul>
          </div>
          <div class="insight">
            <h4>Processing Steps</h4>
            <ul>
              <li>File parsing (PDF/DOCX)</li>
              <li>Text extraction</li>
              <li>8-section analysis</li>
              <li>Risk assessment</li>
              <li>Compliance check</li>
              <li>Report generation</li>
            </ul>
          </div>
          <div class="insight">
            <h4>Privacy & Security</h4>
            <p style="font-size: 13px; line-height: 1.5; color: var(--muted);">
              All processing happens in your browser. Contract files are never uploaded to any server except OpenAI for analysis.
            </p>
          </div>
        </aside>
      </section>
    </main>

    <!-- ===== FOOTER ===== -->
    <footer class="footer">
      <p>&copy; 2024-2026 Atlantic Pipe Services. CR2A Contract Analysis Platform v2.0 - GitHub Pages Edition</p>
    </footer>
  </div>

  <!-- ===== SETTINGS MODAL (Hidden by default) ===== -->
  <div id="settings-modal" class="modal-overlay" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3>Settings</h3>
        <button class="btn ghost small" id="close-settings">√ó</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label for="api-key-input">OpenAI API Key</label>
          <input 
            type="password" 
            id="api-key-input" 
            placeholder="sk-..." 
            autocomplete="off"
          />
          <p class="field-help">
            Your API key is stored locally and only sent to OpenAI. 
            <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener">Get your API key</a>
          </p>
        </div>
        <div class="field">
          <label for="model-select">Model</label>
          <select id="model-select">
            <option value="gpt-4-turbo-preview">GPT-4 Turbo (Recommended)</option>
            <option value="gpt-4">GPT-4</option>
            <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Faster, less accurate)</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn ghost" id="clear-api-key">Clear API Key</button>
        <button class="btn primary" id="save-settings">Save Settings</button>
      </div>
    </div>
  </div>

  <!-- ===== NOTIFICATION CONTAINER ===== -->
  <div id="notifications"></div>

  <!-- ===== EXTERNAL LIBRARIES ===== -->
  <!-- PDF.js for PDF parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <!-- Mammoth.js for DOCX parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- FileSaver.js for file downloads -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <!-- ===== CR2A SERVICES ===== -->
  <!-- Configuration -->
  <script src="./config.js"></script>

  <!-- Core Services -->
  <script src="./services/fileParser.js"></script>
  <script src="./services/promptBuilder.js"></script>
  <script src="./services/openaiService.js"></script>
  <script src="./services/workflowController.js"></script>

  <!-- Utilities -->
  <script src="./utils/storageManager.js"></script>

  <!-- Environment & Main App -->
  <script src="./env.js"></script>
  <script src="./app.js"></script>

  <!-- ===== INLINE UTILITIES ===== -->
  <script>
    // Dark Mode Toggle
    const themeToggle = document.getElementById('theme-toggle');
    const htmlElement = document.documentElement;
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

    // Initialize theme from ConfigManager or system preference
    const savedTheme = (typeof ConfigManager !== 'undefined' ? ConfigManager.getTheme() : null) || 
                       localStorage.getItem('theme') || 
                       (prefersDark ? 'dark' : 'light');

    if (savedTheme === 'dark') {
      htmlElement.setAttribute('data-theme', 'dark');
      themeToggle.textContent = '‚òÄÔ∏è Light';
    }

    themeToggle.addEventListener('click', () => {
      const currentTheme = htmlElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      htmlElement.setAttribute('data-theme', newTheme);

      if (typeof ConfigManager !== 'undefined') {
        ConfigManager.saveTheme(newTheme);
      } else {
        localStorage.setItem('theme', newTheme);
      }

      themeToggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
    });

    // Settings Modal Management
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const closeSettingsBtn = document.getElementById('close-settings');
    const saveSettingsBtn = document.getElementById('save-settings');
    const clearApiKeyBtn = document.getElementById('clear-api-key');
    const apiKeyInput = document.getElementById('api-key-input');
    const modelSelect = document.getElementById('model-select');

    settingsBtn?.addEventListener('click', () => {
      // Load current settings
      if (typeof ConfigManager !== 'undefined') {
        const currentKey = ConfigManager.getApiKey();
        const currentModel = ConfigManager.getModel();
        if (currentKey) {
          apiKeyInput.value = currentKey;
        }
        modelSelect.value = currentModel;
      }
      settingsModal.style.display = 'flex';
    });

    closeSettingsBtn?.addEventListener('click', () => {
      settingsModal.style.display = 'none';
    });

    saveSettingsBtn?.addEventListener('click', () => {
      const apiKey = apiKeyInput.value.trim();
      const model = modelSelect.value;

      if (apiKey && typeof ConfigManager !== 'undefined') {
        try {
          ConfigManager.saveApiKey(apiKey);
          ConfigManager.saveModel(model);
          showNotification('Settings saved successfully!', 'success');
          settingsModal.style.display = 'none';

          // Update ready status
          const readyStatus = document.getElementById('ready-status');
          if (readyStatus) {
            readyStatus.textContent = 'Ready';
            readyStatus.className = 'pill success';
          }
        } catch (error) {
          showNotification(error.message, 'error');
        }
      } else if (!apiKey) {
        showNotification('Please enter a valid API key', 'error');
      }
    });

    clearApiKeyBtn?.addEventListener('click', () => {
      if (typeof ConfigManager !== 'undefined') {
        ConfigManager.clearApiKey();
        apiKeyInput.value = '';
        showNotification('API key cleared', 'info');
      }
    });

    // Close modal on overlay click
    settingsModal?.addEventListener('click', (e) => {
      if (e.target === settingsModal) {
        settingsModal.style.display = 'none';
      }
    });

    // Form Validation
    const form = document.getElementById('submission-form');
    const formInputs = form?.querySelectorAll('input[required], textarea[required]');

    formInputs?.forEach(input => {
      input.addEventListener('blur', validateField);
      input.addEventListener('change', validateField);
    });

    function validateField(e) {
      const field = e.target.closest('.field');
      const isValid = e.target.checkValidity();

      if (isValid) {
        field?.classList.remove('error');
      } else if (e.target.value) {
        field?.classList.add('error');
      }
    }

    // Notification System
    function showNotification(message, type = 'info') {
      const container = document.getElementById('notifications');
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      notification.setAttribute('role', 'alert');
      container.appendChild(notification);

      // Add animation class
      setTimeout(() => notification.classList.add('show'), 10);

      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }

    // Export notification helper to window for app.js
    window.showNotification = showNotification;

    // Check for API key on page load
    if (typeof ConfigManager !== 'undefined' && !ConfigManager.hasApiKey()) {
      setTimeout(() => {
        showNotification('‚öôÔ∏è Please configure your OpenAI API key in Settings', 'warning');
      }, 1000);
    }
  </script>
</body>
</html>